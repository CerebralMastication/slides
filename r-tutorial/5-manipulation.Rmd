---
title: "Manipulation"
output:
  xaringan::moon_reader:
    css: ["default", "custom.css"]
    chakra: libs/remark-latest.min.js
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

class: dv

# Manipulation using dplyr and tidyr 

* Three main things to talk about

  * Data transformation
  
  * The pipe
  
  * Data tidying
  
---

class: dv

# Data - flights from nycflights13
  
```{r, echo = FALSE, message=FALSE}
library(tidyverse)
library(nycflights13)

flights <- flights %>%
  select(year, month, day, dep_time, sched_dep_time, carrier, distance) %>%
  filter(!is.na(dep_time))
```

```{r, eval=FALSE}
flights
```
  
```{r, echo=FALSE, message=FALSE}
library(nycflights13)

rmarkdown:::print.paged_df(flights)

c(rows = dim(flights)[1], cols = dim(flights)[2])
```

---

class: dv

# select() columns

<br>
<br>

![](img/select.png)


---

class: dv

# select() columns

* Extract specific columns

```{r}
# Select year and carrier
# Store in a new data frame
yr_carrier <- select(flights, year, carrier)

yr_carrier
```

---

class: dv

# The pipe %>%

--

.pull-left[

* The _object_ to the left of the pipe becomes the _first argument_ of the function on the right

![](./img/pipe.png)

]

--

.pull-right[

![](img/pipeitup.jpg)

]

---

class: dv

# The pipe %>%

.pull-left[

* The _object_ to the left of the pipe becomes the _first argument_ of the function on the right

![](./img/pipe.png)

]

.pull-right[

```{r}
# Readability is the 
# focus of the pipe!

flights %>%
  select(dep_time) %>%
  head(4)

# head(select(flights, dep_time), 4)
```

]

---

class: dv

# filter() for specific rows

<br>
<br>

![](img/filter.png)

---

class: dv

# filter() for specific rows

* Only American Airlines flights? (In Excel, might add a _filter_ on the table)

```{r}
AA <- filter(flights, carrier == "AA")
head(AA, 2)
```

--

```{r}
# With pipes
flights %>%
  filter(carrier == "AA") %>%
  head(2)
```


---

class: dv

# arrange() to order rows 

* Order by distance? Lowest to highest? Vice versa?

```{r}
flights %>%
  arrange(distance)
```

---

class: dv

# arrange() to order rows 

* Order by distance? Lowest to highest? Vice versa?

```{r}
flights %>%
  arrange(desc(distance)) # descending order
```

---

class: dv

# A question

* Can we categorize flights as:

  * early
  
  * late 
  
  * really late

* Can we quantify "late" and "really late"?

```{r}
flights
```

---

class: dv

# mutate() to add new columns

<br>
<br>

![](img/mutate.png)


---

class: dv

# mutate() to add new columns

```{r}
flights_late <- flights %>%
  mutate(late_time = dep_time - sched_dep_time)

flights_late
```

---

class: dv

# mutate() to add new columns

* Of the flights that are late, define the 75th percentile to be "really late"

* How late is the 75th percentile?

```{r}
flights_late %>%
  filter(late_time > 0) %>%  # Only look at late flights
  pull(late_time) %>%        # Extract the late column
  quantile()                 # The quantiles of the late flights
```

---

class: dv

# mutate() and case_when()

* Imagine doing this with Excel formulas - nested If/Or

```{r}
flights_cat <- flights_late %>% 
  mutate(
    
    # Separate the flights into 3 categories
    late_category = case_when(
      late_time <= 0   ~ "early",
      late_time <= 87  ~ "late",
      TRUE             ~ "really late")) %>%
  
  # Only select relevant columns
  select(dep_time, sched_dep_time, late_time, late_category)
```

---

class: dv

# mutate() and case_when()

```{r, echo = FALSE}
rmarkdown:::print.paged_df(flights_cat)

flights_cat %>% count(late_category)
```

---

class: dv

# group_by() and summarize()

* Often, data sets are grouped and aggregated to get a coarser level of insights

* Think _pivot tables_ from Excel

* In R, these manipulations are accomplished using _grouped data frames_.

![](img/group_summary.png)

---

class: dv

# group_by() and summarize()

* For `flights`, what if we wanted the average `distance` for each `month`?

```{r, include=FALSE}
options(tibble.print_min = 12)
```


```{r}
flights_late %>%
  group_by(month) %>%                      # Group rows by month 1, 2, ..., 12
  summarize(avg_distance = mean(distance), # For each group, avg distance
            avg_delay    = mean(late_time))
```

```{r, include=FALSE}
options(tibble.print_min = 10)
```

---

class: dv

# group_by() and summarize()

![](./img/group_by.png)

---

class: dv

# Tidy data

* There are three interrelated rules which make a dataset tidy:

      1. Each _variable_ must have its own _column_.

      2. Each _observation_ must have its own _row_.
  
      3. Each _value_ must have its own _cell_.
    
![](./img/tidy.png)

* Tidy data makes your analysis steps feel natural

---

class: dv

# Tidy VS Untidy example

```{r}
library(readxl)
de <- read_excel(path = "data/example_de.xlsx")

head(de)
```

* Not tidy! Think about performing a `group_by` to get the average de for each product. Can't group on columns!

---

class: dv

# Tidying up - gather() and spread()

<br></br>

![](./img/gather.png)


---

class: dv

# Tidying up - gather() and spread()

* `gather()` multiple columns together

```{r}
de %>% 
  gather(key = product, value = de, -scenario, -year)
```

---

class: dv

# Tidying up - gather() and spread()

* Why did I do that? Calculations are much easier to handle

```{r}
de %>% 
  gather(key = product, value = de, -scenario, -year) %>%
  group_by(product) %>%
  summarise(`0th percentile`  = quantile(de, probs = 0),
            `10th percentile` = quantile(de, probs = .1))
```

<br></br>

* Also, visualizations are built around data being in this form

---

class: dv

# Tidying up - gather() and spread() 

* `spread()` is the complement to `gather()`

![](img/spread.png)


---

class: dv

# Tidying up - gather() and spread()

* `spread()` is the complement to `gather()`

```{r}
gathered_de <- de %>% gather(key = product, value = de, -scenario, -year)

gathered_de %>%
  spread(key = product, value = de) %>%
  head()
```

---

class: dv

# Wrap up

* What is a tibble / data frame?

* How to install a package?

--

* Basic visualization with ggplot2 

  * Scatter plot
  
  * Line graph
  
  * Bar chart

* Faceting

--

* Data manipulation

  * mutate
  
  * group_by + summarize
  
  * gather + spread

---

class: dv

# Thank you!

* Help document with more R references

* Stack Overflow + Google solve everything

* I'm here until tomorrow

