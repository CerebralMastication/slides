---
title: "Database manipulation"
output:
  html_document:
    highlight: tango
    df_print: paged
---

---

## Start with a question!

### _How did the Average Statuatory Reserve change from 1Q16 to 3Q16?_

#### Specifically, we want to look at the change in stat reserve for each _Plancode_ and for each _Sex_. 

---

```{r echo=FALSE, message=FALSE, warning = FALSE}
library(DBI)
library(dbplyr)
library(tidyverse)

# Show the table
cn <- dbConnect(drv = odbc::odbc(), dsn = "fictrad_ail")
tbl_1q16 <- tbl(cn, "1q16")
tbl_1q16
```

### Doing 4 things

* Connect to the database / specific tables

* Add a new column to differentiate 1q16 from 3q16

* Select 4 relevant columns for our question

* Join the tables together and pull them into R
 
---

```{r, warning = FALSE}
start_time <- proc.time()

# Connect to database
cn <- dbConnect(drv = odbc::odbc(), dsn = "fictrad_ail")

# Connect to the 1q16 and 3q16 tables
tbl_1q16 <- tbl(cn, "1q16")
tbl_3q16 <- tbl(cn, "3q16")

# Manipulate and join them
joined_data <- list(tbl_1q16, tbl_3q16) %>%
  
  map2(c("1q16", "3q16"), 
       
         # For each table...
       ~ .x %>%
         
         # Add a new column
         mutate(quarter = .y) %>%
         
         # Select relevant columns
         select(`//ALFA_PLANCODE`, ALFA_Sex, quarter, InitStatRes) %>%
         
         # Collect results from the database
         collect()) %>%
  
  # Join the two results 
  bind_rows()

proc.time() - start_time
```

### But how much data was this?

```{r, echo = FALSE}
c(rows = dim(joined_data)[1], columns = dim(joined_data)[2])

joined_data
```

### Average Statuatory Reserve from 1q16 -> 3q16

#### Broken down by Plancode and Sex 

```{r}
joined_data %>%
  
  # Grouping by plancode, sex, and quarter
  group_by(`//ALFA_PLANCODE`, ALFA_Sex, quarter) %>%
  
  # For each group, calculate the average stat reserve
  summarise(avg_stat_reserve = mean(InitStatRes)) %>%
  
  # Spread it out by quarter so you can compare the two
  spread(key = quarter, value = avg_stat_reserve)
```


